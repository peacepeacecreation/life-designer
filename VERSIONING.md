# üïê Canvas Versioning System

## –û–≥–ª—è–¥

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è canvas –∑ –¥–≤–æ–º–∞ —Ä—ñ–≤–Ω—è–º–∏ –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö.

## –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Canvas –ó–º—ñ–Ω–∏ (nodes/edges)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Autosave (3s) ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚ñº                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  localStorage‚îÇ    ‚îÇ  Supabase DB ‚îÇ
‚îÇ  (10 –≤–µ—Ä—Å—ñ–π) ‚îÇ    ‚îÇ (‚àû –≤–µ—Ä—Å—ñ–π)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ                     ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ Restore Dialog ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### 1. Database (canvas_history)

**–¢–∞–±–ª–∏—Ü—è:**
```sql
canvas_history (
  id UUID,
  canvas_id UUID,
  user_id UUID,
  nodes JSONB,
  edges JSONB,
  title TEXT,
  version_number INTEGER,
  created_at TIMESTAMPTZ
)
```

**–¢—Ä–∏–≥–µ—Ä:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î –≤–µ—Ä—Å—ñ—é –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É INSERT/UPDATE –≤ `canvas_workspaces`
- –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î `version_number` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
- –ó–±–µ—Ä—ñ–≥–∞—î –ø–æ–≤–Ω–∏–π snapshot (nodes + edges)

### 2. Local Backup (localStorage)

**–§–∞–π–ª:** `src/lib/canvas/local-backup.ts`

**–§—É–Ω–∫—Ü—ñ—ó:**
- `saveCanvasBackup()` - –∑–±–µ—Ä—ñ–≥–∞—î –≤–µ—Ä—Å—ñ—é
- `getCanvasBackups()` - –æ—Ç—Ä–∏–º—É—î –≤—Å—ñ –≤–µ—Ä—Å—ñ—ó
- `getLatestBackup()` - –æ—Å—Ç–∞–Ω–Ω—è –≤–µ—Ä—Å—ñ—è
- `restoreFromBackup()` - –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –≤–µ—Ä—Å—ñ—é

**–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:**
- –ú–∞–∫—Å–∏–º—É–º 10 –≤–µ—Ä—Å—ñ–π (FIFO)
- –ó–±–µ—Ä—ñ–≥–∞—î timestamp –¥–ª—è –∫–æ–∂–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó
- –ü—Ä–∞—Ü—é—î offline

### 3. Autosave Integration

**–§–∞–π–ª:** `src/lib/canvas/autosave.ts`

**–ó–º—ñ–Ω–∏:**
```typescript
// –ü–µ—Ä–µ–¥ –∫–æ–∂–Ω–∏–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
if (currentCanvasId) {
  saveCanvasBackup(currentCanvasId, data.nodes, data.edges, data.title);
}
```

### 4. UI Component

**–§–∞–π–ª:** `src/components/canvas/RestoreBackupDialog.tsx`

**–§—É–Ω–∫—Ü—ñ—ó:**
- –ü–æ–∫–∞–∑—É—î —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å—ñ–π –∑ timestamp
- –í—ñ–¥–æ–±—Ä–∞–∂–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å nodes/edges
- –î–æ–∑–≤–æ–ª—è—î –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–µ—Ä—Å—ñ—é —è–∫ JSON
- –ö–Ω–æ–ø–∫–∞ "–í—ñ–¥–Ω–æ–≤–∏—Ç–∏" –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ rollback

## –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –£ –∫–æ–¥—ñ:

```typescript
import { saveCanvasBackup, getCanvasBackups, getLatestBackup } from '@/lib/canvas/local-backup';

// –ó–±–µ—Ä–µ–≥—Ç–∏ backup
saveCanvasBackup(canvasId, nodes, edges, title);

// –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ backups
const backups = getCanvasBackups(canvasId);

// –û—Ç—Ä–∏–º–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π backup
const latest = getLatestBackup(canvasId);
```

### –£ UI:

1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É `‚è±Ô∏è History` —É –≤–µ—Ä—Ö–Ω—å–æ–º—É –ø—Ä–∞–≤–æ–º—É –∫—É—Ç—ñ
2. –û–±–µ—Ä—ñ—Ç—å –≤–µ—Ä—Å—ñ—é –∑—ñ —Å–ø–∏—Å–∫—É
3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–í—ñ–¥–Ω–æ–≤–∏—Ç–∏" –∞–±–æ "Download" (—Å–∫–∞—á–∞—Ç–∏ JSON)

## –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –ë–î —á–µ—Ä–µ–∑ SQL

```sql
-- –ü–æ–¥–∏–≤–∏—Ç–∏—Å—è –≤—Å—ñ –≤–µ—Ä—Å—ñ—ó
SELECT version_number,
       jsonb_array_length(nodes) as nodes_count,
       created_at
FROM canvas_history
WHERE canvas_id = 'your-canvas-id'
ORDER BY version_number DESC;

-- –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–æ –≤–µ—Ä—Å—ñ—ó #5
SELECT restore_canvas_from_history(
  'your-canvas-id',
  5
);
```

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### –ó–º—ñ–Ω–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–∏—Ö backups:

```typescript
// src/lib/canvas/local-backup.ts
const MAX_BACKUPS = 20; // –∑–∞–º—ñ—Å—Ç—å 10
```

### –ó–º—ñ–Ω–∏—Ç–∏ —ñ–Ω—Ç–µ—Ä–≤–∞–ª autosave:

```typescript
// src/lib/canvas/autosave.ts
debounceMs: 5000, // 5 —Å–µ–∫—É–Ω–¥ –∑–∞–º—ñ—Å—Ç—å 3
```

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ dev server
pnpm dev

# 2. –í—ñ–¥–∫—Ä–∏—Ç–∏ canvas
http://localhost:3077/canvas?id=your-canvas-id

# 3. –ó—Ä–æ–±–∏—Ç–∏ –∑–º—ñ–Ω–∏ (–¥–æ–¥–∞—Ç–∏ –±–ª–æ–∫)

# 4. –ü–æ—á–µ–∫–∞—Ç–∏ 3 —Å–µ–∫—É–Ω–¥–∏

# 5. –í—ñ–¥–∫—Ä–∏—Ç–∏ DevTools Console - –ø–æ–±–∞—á–∏—Ç–µ:
# [LocalBackup] Saved backup v1 for canvas ...

# 6. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ History ‚Üí –ø–æ–±–∞—á–∏—Ç–µ –≤–µ—Ä—Å—ñ—ó
```

## –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ –ë–î

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –ø—Ä–∞—Ü—é—î —Ç—Ä–∏–≥–µ—Ä
./scripts/check-canvas-data.sh

# –ê–±–æ –Ω–∞–ø—Ä—è–º—É —á–µ—Ä–µ–∑ SQL:
export $(cat .env.local | grep -v '^#' | xargs)
curl -X POST \
  "https://api.supabase.com/v1/projects/gxzzkcthcdtmkdwfdrhv/database/query" \
  -H "Authorization: Bearer $SUPABASE_PAT" \
  -H "Content-Type: application/json" \
  -d '{"query": "SELECT COUNT(*) FROM canvas_history WHERE canvas_id = '\''your-canvas-id'\''"}' | jq .
```

## Troubleshooting

### –í–µ—Ä—Å—ñ—ó –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –ë–î

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç—Ä–∏–≥–µ—Ä:
```sql
SELECT * FROM information_schema.triggers
WHERE event_object_table = 'canvas_workspaces';
```

2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ RLS policies:
```sql
SELECT * FROM canvas_history; -- –º–∞—î –ø–æ–∫–∞–∑–∞—Ç–∏ –≤–µ—Ä—Å—ñ—ó
```

### –í–µ—Ä—Å—ñ—ó –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ DevTools ‚Üí Application ‚Üí Local Storage
2. –ó–Ω–∞–π–¥—ñ—Ç—å –∫–ª—é—á `canvas_backup_your-canvas-id`
3. –Ø–∫—â–æ –ø–æ—Ä–æ–∂–Ω—å–æ - –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ console –Ω–∞ –ø–æ–º–∏–ª–∫–∏

### Restore Dialog –ø–æ—Ä–æ–∂–Ω—ñ–π

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ —î –≤–µ—Ä—Å—ñ—ó: `getCanvasBackups(canvasId)`
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ console –Ω–∞ –ø–æ–º–∏–ª–∫–∏
3. –û—á–∏—Å—Ç—ñ—Ç—å localStorage —ñ —Å–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É

## –ë–µ–∑–ø–µ–∫–∞

### RLS Policies

```sql
-- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –±–∞—á–∞—Ç—å —Ç—ñ–ª—å–∫–∏ —Å–≤–æ—é —ñ—Å—Ç–æ—Ä—ñ—é
CREATE POLICY "Users can view their own canvas history"
  ON canvas_history FOR SELECT
  USING (user_id = auth.uid());
```

### localStorage

- –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- –ù–µ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- –û—á–∏—â–∞—î—Ç—å—Å—è –ø—Ä–∏ logout (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

## –ú–∞–π–±—É—Ç–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

- [ ] –ö–æ–º–ø—Ä–µ—Å—ñ—è –≤–µ–ª–∏–∫–∏—Ö backups (gzip)
- [ ] Diff –º—ñ–∂ –≤–µ—Ä—Å—ñ—è–º–∏ (–ø–æ–∫–∞–∑–∞—Ç–∏ —â–æ –∑–º—ñ–Ω–∏–ª–æ—Å—å)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö –≤–µ—Ä—Å—ñ–π (>30 –¥–Ω—ñ–≤)
- [ ] Export/Import –≤—Å—ñ—î—ó —ñ—Å—Ç–æ—Ä—ñ—ó
- [ ] Collaborative versioning (merge conflicts)
- [ ] Tags –¥–ª—è –≤–∞–∂–ª–∏–≤–∏—Ö –≤–µ—Ä—Å—ñ–π ("v1.0", "–ø–µ—Ä–µ–¥ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—î—é")

## FAQ

**Q: –°–∫—ñ–ª—å–∫–∏ –º—ñ—Å—Ü—è –∑–∞–π–º–∞—é—Ç—å backups?**
A: –ó–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ä–æ–∑–º—ñ—Ä—É canvas. –ó–∞–∑–≤–∏—á–∞–π –∫–æ–∂–Ω–∞ –≤–µ—Ä—Å—ñ—è ~10-50KB. 10 –≤–µ—Ä—Å—ñ–π = ~100-500KB.

**Q: –ß–∏ –º–æ–∂–Ω–∞ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–∏–π canvas?**
A: –¢–∞–∫, —è–∫—â–æ —î backup –≤ localStorage –∞–±–æ –≤ canvas_history (—è–∫—â–æ canvas –Ω–µ –±—É–≤ –≤–∏–¥–∞–ª–µ–Ω–∏–π –∑ –ë–î –ø–æ–≤–Ω—ñ—Å—Ç—é).

**Q: –ß–∏ –ø—Ä–∞—Ü—é—î –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö?**
A: –¢–∞–∫, localStorage –ø—Ä–∞—Ü—é—î –Ω–∞ –≤—Å—ñ—Ö —Å—É—á–∞—Å–Ω–∏—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö.

**Q: –ß–∏ –º–æ–∂–Ω–∞ –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é?**
A: –¢–∞–∫, –∫–æ–∂–Ω—É –≤–µ—Ä—Å—ñ—é –º–æ–∂–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —è–∫ JSON —Ñ–∞–π–ª.
